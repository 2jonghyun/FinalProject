<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>여행계획 상세</title>
<style type="text/css">
	.rec{
		border: 2px red solid;
	}
	#updateRecoment{
		dsiplay: none;
	}
</style>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
<script type="text/javascript">
	$(function(){
		var login = $("#login_user").val();
		var no = $("#no").val();

		//댓글 목록 가져오기
		function listRecoment(no){
			$.ajax({
				url: "/recoment/list",
				data: {
					no: no
				},
				success: function(arr){
					$("#listRecoment").empty();
					$.each(arr, function(){
						var div = $("<div></div>").addClass("rec");
						
						var rec_no = $("<p></p>").html(this.recNo);
						var member_id = $("<p></p>").html(this.member_id);
						var content = $("<p></p>").html(this.rec_content);
						var rec_date = $("<p></p>").html(this.rec_date);
						$(div).append(rec_no, member_id, content, rec_date);
						if(login == this.member_id){
							var btnUpdate = $("<button id='btnUpdate'>수정</button>").attr("recNo",this.recNo);
							var btnDelete = $("<button id='btnDelete'>삭제</button>").attr("recNo",this.recNo);
							$(div).append(btnUpdate, btnDelete);
						}
						
						$("#listRecoment").append(div);
					});
					$("#updateRecoment").css("display", "none");
				}
			});
		}
		
		listRecoment(no);
		
		//댓글 수정
		$(document).on("click","#btnUpdate", function(){
			var recNo = $(this).attr("recNo");
			console.log(recNo);
			var data = $("#writeRecoment").serializeArray();
			$("#writeRecoment").append($("<input>").attr("id", "rec_no").attr("name", "rec_no"));
			
			//input에 값 보여주기
			$.ajax({
				url: "/recoment/get",
				data: {
					recNo: recNo
				},
				success: function(re){
					console.log(re.recNo);
					$("#member_id").val(re.member_id);
					$("#rec_content").val(re.rec_content);
					$("#rec_no").val(re.recNo);
					$("#insertRecoment").css("display", "none");
					$("#updateRecoment").css("display", "inline-block");
				}
			});
		
			
			//수정
			$("#updateRecoment").click(function(){
				console.log("click");
				var data = $("#writeRecoment").serializeArray();
				console.log(data);
				$.ajax({
					url: "/recoment/update",
					data: {
						rec_content: $("#rec_content").val(),
						rec_no: recNo
					},
					success: function(re){
						console.log(re);
						listRecoment(no);
						
					}
				});
	
			});
		});
		

		
		//댓글 등록
		$("#insertRecoment").click(function(){
			var data = $("#writeRecoment").serializeArray();
			$.ajax({
				url: "/recoment/insert",
				data: data,
				success: function(re){
					listRecoment(no);
				}
			});
		});
		
		//댓글 삭제
		$(document).on("click","#btnDelete",function(){
			var recNo = $(this).attr("recNo");
			if(confirm("삭제하시겠습니까?")){
				$.ajax({
					url: "/recoment/delete",
					data: {
						recNo: recNo
					},
					success: function(re){
						console.log(re);
						listRecoment(no);
					}
				});
			}
		}); //end 삭제
		
		
		//좋아요
		//좋아요 수 가져오기
		function getLiked(){
			$.ajax({
				url: "/plan/detail/liked",
				data: {
					plan_no: no
				},
				success: function(re){
					$("#cntLiked").val(re);
				}
			});
		}
		
		getLiked();
		
		$("#liked").click(function(){
			var state = $("#liked").prop("checked");
			if(state == true){
				console.log("찜");
				$.ajax({
					url: "/plan/detail/liked/insert",
					data: {
						member_id: login,
						no: no,
						plan_img: $("#plan_img").html(),
						liked_title: $('#plan_title').html()
					},
					success: function(re){
						console.log("re:" + re);
						getLiked();
						getUserLiked(login);
					}
				});
				
			}else{
				$.ajax({
					url: "/plan/detail/liked/delete",
					data: {
						no: no
					},
					success: function(re){
						console.log("삭제결과:"+re);
						getLiked();
						getUserLiked(login);
					}
				});
			}
		});
		
		//찜 눌러져 있는지 아닌지 보여주기
		function getUserLiked(login){
			$.ajax({
				url: "/plan/detail/liked/"+login,
				data: {
					no: no
				},
				success: function(re){
					console.log("user re:" + re);
					if(re == 1){
						$("#liked").prop("checked", true);
					}
				}
			});
		}
		
		getUserLiked(login);
		
		
		//여행계획 삭제
		$("#deletePlan").click(function(e){
			e.preventDefault();
			var plan_no = $("#plan_no").val();
			if(confirm("삭제하시겠습니까?")){
			console.log("p:" + plan_no);
				//$("#submit").unbind('click').click();
				location.href = "/plan/delete/"+plan_no;
			}
		});
		
	});
</script>
</head>
<body>
	<h2>여행계획 상세</h2>
	로그인한 유저 : <input type="text" name="login_user" id="login_user" value="hong">
	
	<a href="/plan/list">목록</a>
	<hr>
	
	
	<!-- 기본 정보 -->
	글번호: <input type="text" th:value="${plan.planNo}" id="plan_no"><br>
	여행일수 : <input type="text" th:value="${cnt}"><br>
	지역 : <span th:text=${region}></span><br>
	<br>

	<table border="1" width="80%">
		<tr>
			<th>제목</th>
			<th>지역</th>
			<th>작성자</th>
			<th>작성일</th>
			<th>조회수</th>
			<th>사진</th>
			<th>여행시작일</th>
			<th>여행종료일</th>
		</tr>
			
		<tr th:each="p:${plan}">
			<td th:text="${p.plan_title}" id="plan_title"></td>
			<td th:text="${region}"></td>
			<td th:text="${p.member_id}"></td>
			<td th:text="${p.plan_date}"></td>
			<td th:text="${p.plan_hit}"></td>
			<td th:text="${p.plan_img}" id="plan_img"></td>
			<td th:text="${p.plan_start}"></td>
			<td th:text="${p.plan_end}"></td>
		</tr>
	</table>
	<br>
	<a th:href="@{'/plan/update/'+${plan.planNo}}" th:text="수정"></a>
	<a th:href="@{'/plan/delete/'+${plan.planNo}}" th:text="삭제" id="deletePlan"></a>
	<br>
	<hr>
	찜 <input type="checkbox" id="liked"><br>
	좋아요수 <input type="text" id="cntLiked">
	<hr>
	<!-- 날짜별 일정 -->
	<div id="day">
		<!-- day1 -->
		<div th:if="${detail1} != null">
		<h2>DAY 1</h2>
			<div th:each="d:${detail1}">
				<span th:text="${d.trip_no}" id="trip_no"></span><br>
				<span th:text="${d.trip_title}"></span><br>
				<span th:text="${d.trip_img}"></span><br>
				<br>
			</div>
		</div>
		<!-- day2 -->
		<div th:if="${detail2} != null">
		<h2>DAY 2</h2>
			<div th:each="d:${detail2}">
				<span th:text="${d.trip_no}"></span><br>
				<span th:text="${d.trip_title}"></span><br>
				<span th:text="${d.trip_img}"></span><br>
				<br>
			</div>
		</div>
		<!-- day3 -->
		<div th:if="${detail3} != null">
		<h2>DAY 3</h2>
			<div th:each="d:${detail3}">
				<span th:text="${d.trip_no}"></span><br>
				<span th:text="${d.trip_title}"></span><br>
				<span th:text="${d.trip_img}"></span><br>
				<br>
			</div>
		</div>
		<!-- day4 -->
		<div th:if="${detail4} != null">
		<h2>DAY 4</h2>
			<div th:each="d:${detail4}">
				<span th:text="${d.trip_no}"></span><br>
				<span th:text="${d.trip_title}"></span><br>
				<span th:text="${d.trip_img}"></span><br>
				<br>
			</div>
		</div>
	</div>
	
	
	
	<hr>
	
	<!-- 댓글 -->
	<div id="recoment">
		<h2>댓글</h2>
		<div id="write">
			<form action="" id="writeRecoment">
				아이디 : <input type="text" name="member_id" id="member_id"><br>
				<input type="text" name="no" th:value="${plan.planNo}" id="no">
				<input type="text" name="type" value="plan" id="type"><br>
				<textarea rows="4" cols="70" name="rec_content" id="rec_content"></textarea>
				<button id="insertRecoment">댓글쓰기</button>
				<button id="updateRecoment">댓글수정</button>
				<!-- <input type="submit" value="댓글쓰기" id="insertRecoment"> -->
			</form>
		</div>
		
		<div id="listRecoment"></div>
		
	</div>
	

</body>
</html>