<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>여행계획 작성</title>
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
<!-- <link rel="stylesheet" href="/resources/demos/style.css"> -->
<style type="text/css">
	* {
		padding: 0;
		margin: 0;
	}
	
	section{
		width: 80%;
		margin: auto;
		margin-bottom: 50px;
		border: 2px solid red;
		
	}
	
	
	#day2_box, #day2 {display: none}
	#day3_box, #day3 {display: none}
	#day4_box, #day4 {display: none}
	
	
	#day{
		border: 2px solid blue;
		width: 350px;
		height: 600px;
		float: left;
		
	}
	
	/* 여행지 목록 */
	#trip_list{
		border: 3px solid black;
		width: 350px;
		height: 600px;
		/* margin-left: 380px; */
		display: inline-block;
		margin-left: 20px;
	}
	
	#map{
		border: 2px solid grey;
		width: 640px;
		height: 600px;
		float: right;
	}
	
	
	.trip{
		border: 2px solid pink;
	}
	
	.selected{
		border: 2px solid blue;
	}
	
	#info{
		border: 2px solid red;
		margin-bottom: 20px;
	}
	

	
	footer{
		clear: both;
	}
	
</style>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=	1c15424bc94cd4eeaedfb92cae5cb928"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script type="text/javascript">
	$(function(){
		
		var login = $("#login_user").val();
		console.log("login:" + login);
		$("#member_id").val(login);
		//카카오 맵
		/* var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
		var options = { //지도를 생성할 때 필요한 기본 옵션
			center: new kakao.maps.LatLng(33.450701, 126.570667), //지도의 중심좌표.
			level: 3 //지도의 레벨(확대, 축소 정도)
		};

		var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴 */
		
		//여행시작일, 여행종료일 선택 시 조건
		$("#plan_start").datepicker({
			dateFormat: "yy-mm-dd",
		});
		//$('#plan_start').datepicker("option", "maxDate", $("#plan_end").val());
	    $('#plan_start').datepicker("option", "onClose", function ( selectedDate ) {
	        $("#plan_end").datepicker( "option", "minDate", selectedDate );
	        $("#plan_end").datepicker( "option", "maxDate", new Date(new Date(selectedDate).getTime() + 3*24*60*60*1000) );
	    });
	    
		$("#plan_end").datepicker({
			dateFormat: "yy-mm-dd"
		});
		$('#plan_end').datepicker("option", "minDate", $("#plan_start").val());
	   
		//날짜 변경 시 이벤트
		$("#plan_start").change(function(){
			var plan_start = new Date($("#plan_start").val()).getTime();
		});
		
		$("#plan_end").change(function(){
			var plan_start = $.datepicker.formatDate("yy-mm-dd", $("#plan_start").datepicker("getDate"));
			var plan_end = $.datepicker.formatDate("yy-mm-dd", $("#plan_end").datepicker("getDate"));

			$("#day2").css("display", "none");
			$("#day3").css("display", "none");
			$("#day4").css("display", "none");
			
			//여행일수 가져오기
			$.ajax({
				url: "/plan/insert/count",
				data: {
					plan_start: plan_start,
					plan_end: plan_end
				},
				success: function(cnt){
					$("#count").val(cnt);
					for(i = 1; i <= cnt; i++){
						console.log(i);
						console.log("#day"+i+"_box");
						$("#day"+i).css("display", "inline-block");
					}
				}
			});
		});
	
		
		
		var region = 0;
		var pageNUM = 1;

		getTotalRecord(region, pageNUM);
		getTripList(pageNUM, region)
		
		$("#trip_region").change(function(){
			region = $("#trip_region").val();
			getTotalRecord(region, pageNUM);
			getTripList(pageNUM, region);
		});

		//페이징 - 전체 레코드 수 가져오기
		function getTotalRecord(region, pageNUM){
			$.ajax({
				url: "/plan/insert/list/record",
				data: {
					region: region
				},
				success: function(total){
					$("#page").empty();
					var totalPage = Math.ceil(total / 8);
					var pageGROUP = 5;
					if(totalPage > pageGROUP){
						console.log("pageNUM:" + pageNUM);
						
						var startPage = (pageNUM-1)/pageGROUP*pageGROUP+1;
						var endPage = startPage+pageGROUP-1;
						if(totalPage < endPage) {
							endPage = totalPage;
						}
						
						console.log("sta:" + startPage);
						console.log("end:" + endPage);
						
						if(startPage > 1){
							var pre = $("<a></a>").html("<").attr({
								"href": "#",
								"pageNUM": startPage - 1
							}).addClass("link").addClass("pre");
							
							$("#page").append(pre);
							$("#page").append("&nbsp;&nbsp;");
						}
						
						for(i = startPage; i <= endPage; i++){
							var num = $("<a></a>").html(i).attr({
								"href": "#",
								"pageNUM": i
							}).addClass("link");
							
							$("#page").append(num);
							$("#page").append("&nbsp;&nbsp;");
						}
						
						if(endPage < totalPage){
							var next = $("<a></a>").html(">").attr({
								"href": "#",
								"pageNUM": endPage + 1
							}).addClass("link").addClass("next");
							$("#page").append(next);
							$("#page").append("&nbsp;&nbsp;");
						}
						
						
					}else{
						for(i = 1; i <= totalPage; i++){
							var num = $("<a></a>").html(i).attr({
								"href": "#",
								"pageNUM": i
							}).addClass("link");
							
							$("#page").append(num);
							$("#page").append("&nbsp;&nbsp;");
						}
						
					}
				}
			});
			
		} //end getTotalRecord()
		
		//페이지 링크 클릭 시 이벤트
		$(document).on("click", ".link", function(){
			pageNUM = $(this).attr("pageNUM");
			getTripList(pageNUM, region);
		});
		
		// < 링크 클릭 이벤트
		$(document).on("click", ".pre", function(){
			pageNUM = $(this).attr("pageNUM");
			getTotalRecord(region, pageNUM-4);
		});
		
		// > 링크 클릭 이벤트
		$(document).on("click", ".next", function(){
			$("#page").empty();
			pageNUM = $(this).attr("pageNUM");
			getTotalRecord(region, pageNUM);
		});
		
		//여행지 목록 가져오기
		function getTripList(pageNUM, region){
			$.ajax({
				url: "/plan/insert/list",
				data: {
					pageNUM: pageNUM,
					region: region
				},
				success: function(arr){
					$("#trip").empty();
					$.each(arr, function(){
						var div = $("<div></div>").addClass("trip").attr({
							"trip_no": this.trip_no,
							"lat": this.lat,
							"lng": this.lng
						});
						var trip_no = $("<div></div>").html(this.trip_no);
						var trip_img = $("<div></div>").html(this.trip_img);
						var trip_title = $("<div></div>").html(this.trip_title);
						
						$(div).append(trip_no, trip_img, trip_title);
						$("#trip").append(div);
					});
				}
			});
		}
	
	
		//여행지 목록에서 여행지 클릭 시 이벤트
		function clickList(){
			var day = "day1";
			
			$(".day_title").click(function(){
				day = $(this).attr("id")
				console.log("Day:" + day);
				
				$(".day_title").css("display", "none");
				$(".box").css("display", "none");
				
				$("#"+day).css("display", "inline-block");
				$("#"+day+"_box").css("display", "inline-block");
			});
	
			$(document).on("click", ".trip", function(){
				var selected = $(".selected_"+day).length;
				console.log("selected:"+selected);
				if(selected < 5){
					var div = $("<div></div>").addClass("add");
					var button = $("<button></button>").html("삭제").attr("id", "btnDelete");
					$(div).append($(this).clone().addClass("selected_"+day).removeClass("trip").attr({
						"n": selected+1,
						"day": day
					}));
					$(div).append(button);
					$("#"+day+"_box").append(div);
					
					//카카오맵
					var lat = $(this).attr("lat");
					var lng = $(this).attr("lng");
					
					var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
					var options = { //지도를 생성할 때 필요한 기본 옵션
						center: new kakao.maps.LatLng(lat, lng), //지도의 중심좌표.
						level: 3 //지도의 레벨(확대, 축소 정도)
					};
					var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
					
				}else{
					alert("최대 5개까지 선택할 수 있습니다.");
				}
				
				//input에 trip_no 추가
				var trip_no = $(this).attr("trip_no");
				$("#"+day+"_"+(selected+1)).val(trip_no);
				
				
			});
		}

		clickList();

		
		//날짜별 전체 삭제
		$(".deleteDay").click(function(e){
			e.preventDefault();
			//day1 전체 삭제 시 plan_img 삭제
			if($(this).attr("id") == "deleteDay1"){
				$("#plan_img").val("");
			}
			
			$(this).siblings("input").val("");
			$(this).siblings(".add").remove();
		});
				
		
		//개별 삭제 버튼 클릭 이벤트
		$(document).on("click", "#btnDelete", function(e){
			e.preventDefault();
			$(this).closest(".add").remove();
			
			var day = $(this).siblings("div").attr("day");
			var n =$(this).siblings("div").attr("n");
			$("#"+day+"_"+n).val("");
			
			if($("#day1_1").val() == ""){
				$("#plan_img").val("");
			}
			
		});
		
		//등록 버튼 클릭 이벤트
		$("#submit").click(function(e){
			e.preventDefault();
			console.log($("#region").val());
			
			if($("#region").val() == ""){
				alert("지역을 선택하세요.")
			}else if($("#plan_title").val() == ""){
				alert("제목을 입력하세요.");
			}else if($("#plan_start").val() == ""){
				alert("여행시작일을 입력하세요.");
			}else if($("#plan_end").val() == ""){
				alert("여행종료일을 입력하세요.");
			}else{
				var days = $("#count").val();
				for(i = 1; i <= days; i++){
					var arr = $("#day"+i+"_box").find(".selected_day"+i)
					$.each(arr, function(index, value){
						$("#day"+i+"_"+(index+1)).val("");
						$("#day"+i+"_"+(index+1)).val($(this).attr("trip_no"));
					});
				}
				
				//이미지 가져오기
				var trip_no = $("#day1_1").val();
				$.ajax({
					url: "/plan/detail/getImg",
					data: {
						trip_no: trip_no
					},
					success: function(img){
						$("#plan_img").val(img);
						$("#submit").unbind('click').click();
					}
				});	
				
			}
			
		}); //#submit 클릭
		
		//다시입력 누르면 선택된 여행지 선택해제
		$("#btnReset").click(function(e){
			e.preventDefault();
			console.log("btnReset");
			$(".add").remove();
		});
		
		
	});
</script>
</head>
<body>
	<input type="hidden" name="login_user" id="login_user" value="hong">
	<h2>여행계획 작성</h2>
	<a href="/plan/list">목록</a>
	
	<!-- 헤더 -->
	<header>
	
	</header>
	
	<section>
		<form action="/plan/insert" method="post" id="insert">
			<!-- 여행계획 기본 정보 -->
			<div id="info">
				<input type="hidden" name="member_id" id="member_id"><br>
				<input type="hidden" name="plan_no" th:value="${nextNo}">
				
				<div class="mb-3">
					<label for="title" class="form-label">제목</label>
					<input type="text" name="plan_title" id="plan_title" class="form-control" placeholder="제목을 입력하세요." style="width: 300px;">
				</div>
				
				<div class="mb-3">
					<label for="start" class="form-label">여행시작일</label>
					<input type="text" name="plan_start" id="plan_start" class="form-control" placeholder="여행시작일을 선택하세요." style="width: 300px;">
				</div>
				
				<div class="mb-3">
					<label for="end" class="form-label">여행종료일</label>
					<input type="text" name="plan_end" id="plan_end" class="form-control" placeholder="여행종료일을 선택하세요." style="width: 300px;">
				</div>
				
				<div class="mb-3">
					<label for="end" class="form-label">지역</label>
					<select id="region" name="korea_code" class="form-select" aria-label="Default select example" style="width: 120px;">
						<option value="" selected>지역선택</option>
						<option th:each="r:${regionlist}" th:text="${r.region}" th:value="${r.code}"></option>
					</select>
				</div>
			
				
				<div id="label_title">
					
				</div>
			
			
				<input type="hidden" name="plan_img" id="plan_img">
				<input type="hidden" id="count">
			</div>
		
			<!-- 여행계획 날짜별 일정 -->
			<div id="day">
			
				<input type="submit" value="등록" id="submit">
				<button id="btnReset">다시입력</button>
			
				<div id="day_title_container">
					<h3 class="day_title" id="day1">DAY 1</h3>
					<h3 class="day_title" id="day2">DAY 2</h3>
					<h3 class="day_title" id="day3">DAY 3</h3>
					<h3 class="day_title" id="day4">DAY 4</h3>
				</div>
				
				<div id="day1_box" class="box">
					<button class="deleteDay" id="deleteDay1">전체삭제</button><br>
					<input type="hidden" name="day1_1" id="day1_1">
					<input type="hidden" name="day1_2" id="day1_2">
					<input type="hidden" name="day1_3" id="day1_3">
					<input type="hidden" name="day1_4" id="day1_4">
					<input type="hidden" name="day1_5" id="day1_5"><br>
				</div>
				
					
				<div id="day2_box" class="box">
					<button class="deleteDay">전체삭제</button><br>
					<input type="text" name="day2_1" id="day2_1">
					<input type="text" name="day2_2" id="day2_2">
					<input type="text" name="day2_3" id="day2_3">
					<input type="text" name="day2_4" id="day2_4">
					<input type="text" name="day2_5" id="day2_5"><br>
				</div>
				
					
				<div id="day3_box" class="box">
					<button class="deleteDay">전체삭제</button><br>
					<input type="text" name="day3_1" id="day3_1">
					<input type="text" name="day3_2" id="day3_2">
					<input type="text" name="day3_3" id="day3_3">
					<input type="text" name="day3_4" id="day3_4">
					<input type="text" name="day3_5" id="day3_5"><br>
				</div>
				
					
				<div id="day4_box" class="box">
					<button class="deleteDay">전체삭제</button><br>
					<input type="text" name="day4_1" id="day4_1">
					<input type="text" name="day4_2" id="day4_2">
					<input type="text" name="day4_3" id="day4_3">
					<input type="text" name="day4_4" id="day4_4">
					<input type="text" name="day4_5" id="day4_5"><br>
				</div>
			</div>
		</form>
		
		<!-- 여행지 목록 -->
		<div id="trip_list">
			<select id="trip_region" name="korea_code">
				<option value="0" selected>전국</option>
				<option th:each="r:${regionlist}" th:text="${r.region}" th:value="${r.code}"></option>
			</select>
			
			<hr>
			
			<div id="trip"></div>
			
			<div id="page"></div>
		
		</div>
		
		
		<!-- 지도 -->
		<div id="map"></div>
		
	</section>
	
	<footer>
	
	</footer>
	
	
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
</body>
</html>