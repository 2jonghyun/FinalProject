<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>여행지 상세</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<style type="text/css">
	.carousel {
	    position: relative;
	    width: 50%;
	    margin-left: auto;
	    margin-right: auto;
	}
	
	.carousel-inner > .carousel-item > img {
		top: 0;
		left: 0;
		min-width: 80%;
		min-height: 200px;
		max-height: 400px;
  	} 

</style>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f12cedc04a3b71edb51a90ae7835e50f"></script>
<script type="text/javascript">
	$(function(){
		var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
	    mapOption = { 
	        center: new kakao.maps.LatLng($("#lat").val(), $("#lng").val()), // 지도의 중심좌표
	        level: 3 // 지도의 확대 레벨
	    };
	
		// 지도를 표시할 div와  지도 옵션으로  지도를 생성
		var map = new kakao.maps.Map(mapContainer, mapOption); 
		
		var markerPosition  = new kakao.maps.LatLng($("#lat").val(), $("#lng").val()); 

		// 마커를 생성
		var marker = new kakao.maps.Marker({
		    position: markerPosition
		});

		// 마우스 휠로 지도 확대,축소 기능 막기
		map.setZoomable(false);  
		
		// 마커가 지도 위에 표시되도록 설정
		marker.setMap(map);
		
		var login = $("#login_user").val();
		var no = $("#no").val();
		
		//좋아요 수 가져오기
		function getLiked(){
			$.ajax({
				url: "/trip/getTripLikedCnt/"+$("#tripLiked").attr("checkLikedNo"),
				success: function(cnt){
					$("#cntLiked").text(cnt);
					console.log(cnt);
				}
			});
		}

		getLiked();
		
		// 해당 아이디가 찜한 게시물 표시
		function getUserLiked(login){
			var tripLikedNoList = new Array();
			var tripLikedNoList2 = new Array();
			
			$.ajax({
				url:"/trip/findAllTripLiked/"+login,
				success:function(tripLikedNoList){
					if(tripLikedNoList != null){
						console.log(tripLikedNoList);
						
						for(i=0; i<tripLikedNoList.length; i++){
							tripLikedNoList2.push(tripLikedNoList[i]);
						}
					}
					
					function isSelect(no){
						re = false;
						
						for(i=0; i<tripLikedNoList2.length; i++){
							if(tripLikedNoList2[i] == no){
								re = true;
								break;
							}
						}
						return re;
					};
					
					if(isSelect( $("#tripLiked").attr("checkLikedNo") )){
						$("#tripLiked").attr("checked","checked");
					}
				}
			});
		};
		
		getUserLiked(login);
		
		// 찜 기능
		$("#tripLiked").click(function(){
			if($(this).is(":checked")){
				$.ajax({
					url:"/trip/tripLiked",
					data:{
						"memberId":"admin12",
						"type":"trip",
						"no": $(this).val(),
						"likeImg":$(this).attr("likeImg"),
						"likedTitle": $(this).attr("likedTitle")
					},
					success:function(re){
						if(re == 1){
							alert("찜!!");
						}
					}
				});
			}

			if($(this).is(":checked")==false){
				$.ajax({
					url:"/trip/tripUnliked",
					data:{
						"memberId":"admin12",
						"type":"trip",
						"no": $(this).val(),
						"likeImg":$(this).attr("likeImg"),
						"likedTitle": $(this).attr("likedTitle")
					},
					success:function(re){
						if(re == 1){
							alert("찜취소!!");
						}
					}
				});
			}
		}); 
		
		//댓글 목록 가져오기
		function listRecoment(no){

			$.ajax({
				url: "/recoment/tripList",
				data: {
					no: no
				},
				success: function(arr){
					$("#listRecoment").empty();
					$.each(arr, function(){
						var div = $("<div></div>").addClass("rec");

						var rec_no = $("<p></p>").html(this.recNo);
						var member_id = $("<p></p>").html(this.memberId);
						var content = $("<p></p>").html(this.recContent);
						var rec_date = $("<p></p>").html(this.recDate);
						$(div).append(rec_no, member_id, content, rec_date);
						if(login == this.memberId){
							var btnUpdate = $("<button id='btnUpdate'>수정</button>").attr("recNo",this.recNo);
							var btnDelete = $("<button id='btnDelete'>삭제</button>").attr("recNo",this.recNo);
							$(div).append(btnUpdate, btnDelete);
						}

						$("#listRecoment").append(div);
					});
					$("#updateRecoment").css("display", "none");
				}
			});
		}

		listRecoment(no);

		//댓글 수정
		$(document).on("click","#btnUpdate", function(){
			var recNo = $(this).attr("recNo");
			console.log(recNo);
			var data = $("#writeRecoment").serializeArray();
			$("#writeRecoment").append($("<input>").attr("id", "rec_no").attr("name", "rec_no"));

			//input에 값 보여주기
			$.ajax({
				url: "/recoment/get",
				data: {
					recNo: recNo
				},
				success: function(re){
					console.log(re.recNo);
					$("#member_id").val(re.memberId);
					$("#rec_content").val(re.recContent);
					$("#rec_no").val(re.recNo);
					$("#insertRecoment").css("display", "none");
					$("#updateRecoment").css("display", "inline-block");
				}
			});


			//수정
			$("#updateRecoment").click(function(){
				console.log("click");
				var data = $("#writeRecoment").serializeArray();
				console.log(data);
				$.ajax({
					url: "/recoment/update",
					data: {
						recContent: $("#rec_content").val(),
						recNo: recNo
					},
					success: function(re){
						console.log(re);
						listRecoment(no);

					}
				});

			});
		});



		//등록
		$("#insertRecoment").click(function(){
			var data = $("#writeRecoment").serializeArray();
			$.ajax({
				url: "/recoment/insert",
				data: data,
				success: function(re){
					listRecoment(no);
				}
			});
		});

		//삭제
		$(document).on("click","#btnDelete",function(){
			var recNo = $(this).attr("recNo");
			if(confirm("삭제하시겠습니까?")){
				$.ajax({
					url: "/recoment/delete",
					data: {
						recNo: recNo
					},
					success: function(re){
						console.log(re);
						listRecoment(no);
					}
				});
			}
		}); //end 삭제
	});
</script>
</head>
<body>
	<h1>여행지 상세</h1>
	<hr>
	로그인한 유저 : <input type="text" name="login_user" id="login_user" value="admin12">
	<hr>
	<div>
		<label th:for="hit">조회수 : </label> 
		<span th:text="${trip.hit}"></span>
	</div>
	<hr>
	찜 <input type="checkbox" id="tripLiked" th:value="${trip.tripNo}" th:attr="likedTitle=${trip.tripTitle},likeImg=${trip.tripImg},checkLikedNo=${trip.tripNo}"><br>
	좋아요수 <span id="cntLiked"></span>
	<hr>
	<div style="width: 80%; text-align: center; margin-left: auto; margin-right: auto;">
		<!-- 관광지명 -->
		<div th:text="${trip.tripTitle}" style="font-weight: bold; font-size: 36px; text-align: center;"></div>
		<!-- 지역명 -->
		<div th:text="${region}"></div>
	</div> 
	
	<!-- 이미지 캐러셀 -->
	<div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="true">
		<div class="carousel-indicators">
		  <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
		  <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
		  <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
		</div>
  		<div class="carousel-inner">
	    	<div class="carousel-item active">
	      		<img th:src="@{'/images/'+${trip.tripImg}}" class="d-block w-100" alt="...">
	    	</div>
	    	<div class="carousel-item" th:each="img:${imgList}">
	      		<img th:src="@{'/images/'+${img.fname}}" class="d-block w-100" alt="...">
	    	</div>
 		</div>
		<button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
		  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
		  <span class="visually-hidden">Previous</span>
		</button>
		<button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
		  <span class="carousel-control-next-icon" aria-hidden="true"></span>
		  <span class="visually-hidden">Next</span>
		</button>
	</div>
	
	<div style="font-weight: bold; font-size: 30px;">상세정보</div>
	<div th:text="${trip.tripDetail}"></div>
	<div>
		<label th:for="tripTel">전화번호 : </label> 
		<span th:text="${trip.tripTel}"></span>
	</div>
	<div>
		<label th:for="site">웹사이트 : </label> 
		<span th:text="${trip.site}"></span>
	</div>
	<div>
		<label th:for="tripAddr">주소 : </label> 
		<span th:text="${trip.tripAddr}"></span>
	</div>
	<div>
		<label th:for="closed">휴무일 : </label> 
		<span th:text="${trip.closed}"></span>
	</div>
	<div>
		<label th:for="opened">이용시간 : </label>
		<span th:text="${trip.opened}"></span>
	</div>
	<div>
		<label th:for="fare">이용요금 : </label>
		<span th:text="${trip.fare}"></span>
	</div>
	
	<div id="map" style="width:60%;height:350px; margin-left: auto; margin-right: auto;"></div>
	<input type="hidden" th:value="${trip.lat}" id="lat">
	<input type="hidden" th:value="${trip.lng}" id="lng">
	
	<!-- 관리자일 때, 수정, 삭제 버튼 보이게 -->
	<div th:if="${grade} == 'admin'">
		<a th:text="수정" th:href="@{|/trip/update/${trip.tripNo}|}"></a>
		<a th:text="삭제" th:href="@{|/trip/delete/${trip.tripNo}|}"></a>
	</div>
	
	<hr>
	<!-- 댓글 -->
	<div id="recoment">
		<h2>댓글</h2>
		<div id="write">
			<form action="" id="writeRecoment">
				아이디 : <input type="text" name="member_id" id="member_id"><br>
				<input type="text" name="no" th:value="${trip.tripNo}" id="no">
				<input type="text" name="type" value="trip" id="type"><br>
				<textarea rows="4" cols="70" name="rec_content" id="rec_content"></textarea>
				<button id="insertRecoment">댓글쓰기</button>
				<button id="updateRecoment">댓글수정</button>
				<!-- <input type="submit" value="댓글쓰기" id="insertRecoment"> -->
			</form>
		</div>

		<div id="listRecoment"></div>

	</div>
</body>
</html>