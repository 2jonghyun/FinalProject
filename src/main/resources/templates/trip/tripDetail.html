<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>여행지 상세</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f12cedc04a3b71edb51a90ae7835e50f"></script>
<script type="text/javascript">
	$(function(){
		var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
	    mapOption = { 
	        center: new kakao.maps.LatLng($("#lat").val(), $("#lng").val()), // 지도의 중심좌표
	        level: 3 // 지도의 확대 레벨
	    };
	
		// 지도를 표시할 div와  지도 옵션으로  지도를 생성
		var map = new kakao.maps.Map(mapContainer, mapOption); 
		
		var markerPosition  = new kakao.maps.LatLng($("#lat").val(), $("#lng").val()); 

		// 마커를 생성
		var marker = new kakao.maps.Marker({
		    position: markerPosition
		});

		// 마커가 지도 위에 표시되도록 설정
		marker.setMap(map);
		
		var login = $("#login_user").val();
		var no = $("#no").val();
		
		//댓글 목록 가져오기
		function listRecoment(no){

			$.ajax({
				url: "/recoment/tripList",
				data: {
					no: no
				},
				success: function(arr){
					$("#listRecoment").empty();
					$.each(arr, function(){
						var div = $("<div></div>").addClass("rec");

						var rec_no = $("<p></p>").html(this.recNo);
						var member_id = $("<p></p>").html(this.memberId);
						var content = $("<p></p>").html(this.recContent);
						var rec_date = $("<p></p>").html(this.recDate);
						$(div).append(rec_no, member_id, content, rec_date);
						if(login == this.member_id){
							var btnUpdate = $("<button id='btnUpdate'>수정</button>").attr("recNo",this.recNo);
							var btnDelete = $("<button id='btnDelete'>삭제</button>").attr("recNo",this.recNo);
							$(div).append(btnUpdate, btnDelete);
						}

						$("#listRecoment").append(div);
					});
					$("#updateRecoment").css("display", "none");
				}
			});
		}

		listRecoment(no);

		//댓글 수정
		$(document).on("click","#btnUpdate", function(){
			var recNo = $(this).attr("recNo");
			console.log(recNo);
			var data = $("#writeRecoment").serializeArray();
			$("#writeRecoment").append($("<input>").attr("id", "rec_no").attr("name", "rec_no"));

			//input에 값 보여주기
			$.ajax({
				url: "/recoment/get",
				data: {
					recNo: recNo
				},
				success: function(re){
					console.log(re.recNo);
					$("#member_id").val(re.membeId);
					$("#rec_content").val(re.recContent);
					$("#rec_no").val(re.recNo);
					$("#insertRecoment").css("display", "none");
					$("#updateRecoment").css("display", "inline-block");
				}
			});


			//수정
			$("#updateRecoment").click(function(){
				console.log("click");
				var data = $("#writeRecoment").serializeArray();
				console.log(data);
				$.ajax({
					url: "/recoment/update",
					data: {
						rec_content: $("#rec_content").val(),
						rec_no: recNo
					},
					success: function(re){
						console.log(re);
						listRecoment(no);

					}
				});

			});
		});



		//등록
		$("#insertRecoment").click(function(){
			var data = $("#writeRecoment").serializeArray();
			$.ajax({
				url: "/recoment/insert",
				data: data,
				success: function(re){
					listRecoment(no);
				}
			});
		});

		//삭제
		$(document).on("click","#btnDelete",function(){
			var recNo = $(this).attr("recNo");
			if(confirm("삭제하시겠습니까?")){
				$.ajax({
					url: "/recoment/delete",
					data: {
						recNo: recNo
					},
					success: function(re){
						console.log(re);
						listRecoment(no);
					}
				});
			}
		}); //end 삭제
	});
</script>
</head>
<body>
	<h1>여행지 상세</h1>
	<hr>
	로그인한 유저 : <input type="text" name="login_user" id="login_user" value="hong">
	<hr>
	<div>
		<label th:for="hit">조회수 : </label> 
		<span th:text="${trip.hit}"></span>
	</div>
	<div>
		<label th:for="tripTitle">관광지명 : </label> 
		<span th:text="${trip.tripTitle}"></span>
	</div>
	<div>
		<label th:for="region">지역명 : </label> 
		<span th:text="${region}"></span>
	</div> 
	<div>
		<label th:for="tripTel">전화번호 : </label> 
		<span th:text="${trip.tripTel}"></span>
	</div>
	<div>
		<label th:for="site">웹사이트 : </label> 
		<span th:text="${trip.site}"></span>
	</div>
	<div>
		<label th:for="tripAddr">주소 : </label> 
		<span th:text="${trip.tripAddr}"></span>
	</div>
	<div>
		<label th:for="closed">휴무일 : </label> 
		<span th:text="${trip.closed}"></span>
	</div>
	<div>
		<label th:for="opened">이용시간 : </label>
		<span th:text="${trip.opened}"></span>
	</div>
	<div>
		<label th:for="fare">이용요금 : </label>
		<span th:text="${trip.fare}"></span>
	</div>
	<div>
		<label th:for="tripDetail">상세정보 : </label>
		<span th:text="${trip.tripDetail}"></span>
	</div>
	<div>
		<label th:for="tripImg">이미지 : </label>
		<div th:text="${trip.tripImg}"></div>
		<img th:src="@{'/images/'+${trip.tripImg}}" width="100" height="100"/>
		<div th:each="img:${imgList}">
			<div th:text="${img.fname}"></div>
			<img th:src="@{'/images/'+${img.fname}}" width="100" height="100"/>
		</div>
	</div>
	<div id="map" style="width:100%;height:350px;"></div>
	<input type="hidden" th:value="${trip.lat}" id="lat">
	<input type="hidden" th:value="${trip.lng}" id="lng">
	
	<!-- 관리자일 때, 수정, 삭제 버튼 보이게 -->
	<div th:if="${grade} == 'admin'">
		<a th:text="수정" th:href="@{|/trip/tripUpdate/${trip.tripNo}|}"></a>
		<a th:text="삭제" th:href="@{|/trip/tripDelete/${trip.tripNo}|}"></a>
	</div>
	
	<hr>
	<!-- 댓글 -->
	<div id="recoment">
		<h2>댓글</h2>
		<div id="write">
			<form action="" id="writeRecoment">
				아이디 : <input type="text" name="member_id" id="member_id"><br>
				<input type="text" name="no" th:value="${trip.tripNo}" id="no">
				<input type="text" name="type" value="trip" id="type"><br>
				<textarea rows="4" cols="70" name="rec_content" id="rec_content"></textarea>
				<button id="insertRecoment">댓글쓰기</button>
				<button id="updateRecoment">댓글수정</button>
				<!-- <input type="submit" value="댓글쓰기" id="insertRecoment"> -->
			</form>
		</div>

		<div id="listRecoment"></div>

	</div>
</body>
</html>